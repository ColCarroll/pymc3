
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multilevel Gravity Survey with MLDA &#8212; PyMC3 3.10.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/semantic-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/default.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script src="../_static/highlight.min.js"></script>
    <script src="../_static/semantic.min.js"></script>
    <link rel="shortcut icon" href="../_static/PyMC3.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-176578023-1']);
  _gaq.push(['_trackPageview']);
</script>
<script>hljs.initHighlightingOnLoad();</script>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">



  </head><body>
<div class="ui vertical center aligned">

    <div class="ui container">
        <div class="ui large secondary pointing menu">
            <a class="item" href="/">
                <img class="ui bottom aligned tiny image" src="https://cdn.rawgit.com/pymc-devs/pymc3/master/docs/logos/svg/PyMC3_banner.svg" />
            </a>
             <a href="../nb_tutorials/index.html" class="item">Tutorials</a> <a href="../nb_examples/index.html" class="item">Examples</a> <a href="../learn.html" class="item">Books + Videos</a> <a href="../api.html" class="item">API</a> <a href="../developer_guide.html" class="item">Developer Guide</a> <a href="../about.html" class="item">About PyMC3</a>
            
            <div class="right menu">
                <div class="item">
                    <form class="ui icon input" action="../search.html" method="get">
                        <input type="text" placeholder="Search..." name="q" />
                        <i class="search link icon"></i>
                    </form>
                </div>
                <a class="item" href="https://github.com/pymc-devs/pymc3"><i class="github blue icon large"></i></a>
            </div>
        </div>
    </div>
    
</div>

<div class="ui container" role="main">
    

    <div class="ui vertical segment">
        
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Multilevel-Gravity-Survey-with-MLDA">
<h1>Multilevel Gravity Survey with MLDA<a class="headerlink" href="#Multilevel-Gravity-Survey-with-MLDA" title="Permalink to this headline">¶</a></h1>
<div class="section" id="The-MLDA-sampler">
<h2>The MLDA sampler<a class="headerlink" href="#The-MLDA-sampler" title="Permalink to this headline">¶</a></h2>
<p>This notebook is designed to demonstrate the Multi-Level Delayed Acceptance MCMC algorithm (MLDA) proposed in Dodwell (2019), as implemented within PyMC3. If you are using MLDA for the first time, we recommend first running the <code class="docutils literal notranslate"><span class="pre">MLDA_simple_linear_regression.ipynb</span></code> notebook in the same folder.</p>
<p>The MLDA sampler can be more efficient than other MCMC samplers when dealing with computationally intensive problems where we have access not only to the desired (fine) posterior distribution but also to a set of approximate (coarse) posteriors of decreasing accuracy and decreasing computational cost. In simple terms, we can use multiple chains on different coarseness levels and coarser chains’ samples are used as proposals for the finer chains. This has been shown to improve the effective
sample size of the finest chain and this allows us to reduce the number of expensive fine-chain likelihood evaluations.</p>
<p>The notebook initially defines the necessary classes that describe the model. These classes use scipy to do the numerical solve in the forward model. It then instantiates models in two levels (with different granularities) and generates data for inference. Finally, the model classes are passed to two pymc3 models using Theano Ops and inference is done using three different MCMC methods (including MLDA). Some summary results and comparison plots are shown at the end to demonstrate the results.
The use of Theano Ops is common when users want to use external code to calculate their likelihood (e.g. some fast PDE solver) and this example is designed to serve as a starting point for users to employ MLDA in their own problems.</p>
<p>Please note that the MLDA sampler is new in PyMC3. The user should be extra critical about the results and report any problems as issues in the pymc3’s github repository.</p>
<p>The notebook results shown below were generated on a MacBook Pro with a 2.6 GHz 6-core Intel Core i7, 32 GB DDR4 and macOS 10.15.4.</p>
</div>
<div class="section" id="Gravity-Surveying">
<h2>Gravity Surveying<a class="headerlink" href="#Gravity-Surveying" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, we solve a 2-dimensional gravity surveying problem, adapted from the 1D problem presented in Hansen (2010).</p>
<p>Our aim is to recover a two-dimensional mass distribution <span class="math notranslate nohighlight">\(f(\vec{t})\)</span> at a known depth <span class="math notranslate nohighlight">\(d\)</span> below the surface from measurements <span class="math notranslate nohighlight">\(g(\vec{s})\)</span> of the vertical component of the gravitational field at the surface. The contribution to <span class="math notranslate nohighlight">\(g(\vec{s})\)</span> from infinitesimally small areas of the subsurface mass distribution are given by:</p>
<dl class="simple">
<dt>:nbsphinx-math:<a href="#id1"><span class="problematic" id="id2">`</span></a>begin{equation}</dt><dd><p>dg = frac{sin theta}{r^2} f(vec{t}) : dvec{t}</p>
</dd>
</dl>
<p>end{equation}` where <span class="math notranslate nohighlight">\(\theta\)</span> is the angle between the vertical plane and a straight line between two points <span class="math notranslate nohighlight">\(f(\vec{t})\)</span> and <span class="math notranslate nohighlight">\(g(\vec{s})\)</span>, and <span class="math notranslate nohighlight">\(r = | \vec{s} - \vec{t} |\)</span> is the Eucledian distance between the points. We exploit that <span class="math notranslate nohighlight">\(\sin \theta = \frac{d}{r}\)</span>, so that</p>
<dl class="simple">
<dt>:nbsphinx-math:<a href="#id3"><span class="problematic" id="id4">`</span></a>begin{equation}</dt><dd><p>frac{sin theta}{r^2} f(vec{t}) : dvec{t} = frac{d}{r^3} f(vec{t}) : dvec{t} = frac{d}{ | vec{s} - vec{t} <a href="#id5"><span class="problematic" id="id6">|</span></a>^3} f(vec{t}) : dvec{t}</p>
</dd>
</dl>
<p>end{equation}`</p>
<p>This yields the integral equation,</p>
<dl class="simple">
<dt>:nbsphinx-math:<a href="#id7"><span class="problematic" id="id8">`</span></a>begin{equation}</dt><dd><p>g(vec{s}) = iint_T frac{d}{ | vec{s} - vec{t} <a href="#id9"><span class="problematic" id="id10">|</span></a>^3} f(vec{t}) : dvec{t}</p>
</dd>
</dl>
<p>end{equation}`</p>
<p>where <span class="math notranslate nohighlight">\(T = [0,1]^2\)</span> is the domain of the function <span class="math notranslate nohighlight">\(f(\vec{t})\)</span>. This constitutes our forward model.</p>
<p>We solve this integral numerically using midpoint quadrature. For simplicity, we use the same number of quadrature points along each axis, so that in discrete form our forward model becomes</p>
<dl class="simple">
<dt>:nbsphinx-math:<a href="#id11"><span class="problematic" id="id12">`</span></a>begin{equation}</dt><dd><p>g(vec{s}_i) = sum_{j=1}^{m} omega_j frac{d}{ | vec{s}_i - vec{t}_j <a href="#id13"><span class="problematic" id="id14">|</span></a>^3} hat{f}(vec{t}_j), quad i = 1, dots, n, quad j = 1, dots, m</p>
</dd>
</dl>
<p>end{equation}`</p>
<p>where <span class="math notranslate nohighlight">\(\omega_j = \frac{1}{m}\)</span> are quadrature weights, <span class="math notranslate nohighlight">\(\hat{f}(\vec{t}_j)\)</span> is the approximate subsurface mass at quadrature points <span class="math notranslate nohighlight">\(j = 1, \dots, m\)</span>, and <span class="math notranslate nohighlight">\(g(\vec{s}_i)\)</span> is surface measurements at collocation points <span class="math notranslate nohighlight">\(i = 1, \dots, n\)</span>. Hence when <span class="math notranslate nohighlight">\(n &gt; m\)</span>, we are dealing with an overdetermined problem and vice versa.</p>
<dl class="simple">
<dt>This results in a linear system <span class="math notranslate nohighlight">\(\mathbf{Ax = b}\)</span>, where :nbsphinx-math:<a href="#id15"><span class="problematic" id="id16">`</span></a>begin{equation}</dt><dd><p>a_{ij} = omega_j frac{d}{ | vec{s}_i - vec{t}_j <a href="#id17"><span class="problematic" id="id18">|</span></a>^3}, quad x_j = hat{f}(vec{t}_j), quad b_i = g(vec{s}_i).</p>
</dd>
</dl>
<p>end{equation}` In this particular problem, the matrix <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> has a very high condition number, leading to an ill-posed inverse problem, which entails numerical instability and spurious, often oscillatory, solutions for noisy right hand sides. These types of problems are traditionally solved by way of some manner of <em>regularisation</em>, but they can be handled in a natural and elegant fashion in the context of a Bayesian inverse problem.</p>
</div>
<div class="section" id="Mass-Distribution-as-a-Gaussian-Random-Process">
<h2>Mass Distribution as a Gaussian Random Process<a class="headerlink" href="#Mass-Distribution-as-a-Gaussian-Random-Process" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>We model the unknown mass distribution as a Gaussian Random Process with a Matern 5/2 covariance kernel (Rasmussen and Williams, 2006): :nbsphinx-math:<a href="#id19"><span class="problematic" id="id20">`</span></a>begin{equation}</dt><dd><p>C_{5/2}(vec{t}, vec{t}’) = sigma^2 left( 1 + frac{sqrt{5} | vec{t}-vec{t}’ | }{l} + frac{5 | vec{t}-vec{t}’ <a href="#id21"><span class="problematic" id="id22">|</span></a>^2}{3l^2} right) exp left( - frac{sqrt{5} | vec{t}-vec{t}’ | }{l} right)</p>
</dd>
</dl>
<p>end{equation}` where <span class="math notranslate nohighlight">\(l\)</span> is the covariance length scale and <span class="math notranslate nohighlight">\(\sigma^2\)</span> is the variance.</p>
</div>
<div class="section" id="Comparison">
<h2>Comparison<a class="headerlink" href="#Comparison" title="Permalink to this headline">¶</a></h2>
<p>Within this notebook, a simple MLDA sampler is compared to a Metropolis and a DEMetropolisZ sampler. The example demonstrates that MLDA is more efficient than the other samplers when measured by the Effective Samples per Second they can generate from the posterior.</p>
</div>
<div class="section" id="References">
<h2>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h2>
<p>Dodwell, Tim &amp; Ketelsen, Chris &amp; Scheichl, Robert &amp; Teckentrup, Aretha. (2019). Multilevel Markov Chain Monte Carlo. SIAM Review. 61. 509-545. <a class="reference external" href="https://doi.org/10.1137/19M126966X">https://doi.org/10.1137/19M126966X</a></p>
<p>Per Christian Hansen. <em>Discrete Inverse Problems: Insight and Algorithms</em>. Society for Industrial and Applied Mathematics, January 2010.</p>
<p>Carl Edward Rasmussen and Christopher K. I. Williams. <em>Gaussian processes for machine learning</em>. Adaptive computation and machine learning. 2006.</p>
<div class="section" id="Import-modules">
<h3>Import modules<a class="headerlink" href="#Import-modules" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENBLAS_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>  <span class="c1"># Set environment variable</span>

<span class="kn">import</span> <span class="nn">sys</span> <span class="k">as</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">theano</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>

<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">eigh</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance_matrix</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">123446</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Checking versions</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Theano version: </span><span class="si">{</span><span class="n">theano</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyMC3 version: </span><span class="si">{</span><span class="n">pm</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Theano version: 1.0.5
PyMC3 version: 3.9.3
</pre></div></div>
</div>
</div>
<div class="section" id="Define-Matern52-kernel-for-modelling-Gaussian-Random-Field">
<h3>Define Matern52 kernel for modelling Gaussian Random Field<a class="headerlink" href="#Define-Matern52-kernel-for-modelling-Gaussian-Random-Field" title="Permalink to this headline">¶</a></h3>
<p>This is utility code which is necessary for defining the model later - you are free to ignore it or place it in an external file</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">SquaredExponential</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">mkl</span><span class="p">,</span> <span class="n">lamb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This class sets up a random process</span>
<span class="sd">        on a grid and generates</span>
<span class="sd">        a realisation of the process, given</span>
<span class="sd">        parameters or a random vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Internalise the grid and set number of vertices.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_field</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Set some random field parameters.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mkl</span> <span class="o">=</span> <span class="n">mkl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assemble_covariance_matrix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">assemble_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a snazzy distance-matrix for rapid</span>
<span class="sd">        computation of the covariance matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># Compute the covariance between all</span>
        <span class="c1"># points in the space.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the covariance matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">compute_eigenpairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find eigenvalues and eigenvectors using Arnoldi iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">,</span> <span class="n">eigvals</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">eigvals</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigvecs</span><span class="p">[:,</span> <span class="n">order</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a random field, see</span>
<span class="sd">        Scarth, C., Adhikari, S., Cabral, P. H.,</span>
<span class="sd">        Silva, G. H. C., &amp; Prado, A. P. do. (2019).</span>
<span class="sd">        Random field simulation over curved surfaces:</span>
<span class="sd">        Applications to computational structural mechanics.</span>
<span class="sd">        Computer Methods in Applied Mechanics and Engineering,</span>
<span class="sd">        345, 283–301. https://doi.org/10.1016/j.cma.2018.10.026</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mkl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">random_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lognormal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the random field.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">lognormal</span><span class="p">:</span>
            <span class="n">random_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_field</span>
            <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">random_field</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">random_field</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">random_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_field</span><span class="p">)</span>
            <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">random_field</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">random_field</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">random_field</span><span class="p">,</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Matern52</span><span class="p">(</span><span class="n">SquaredExponential</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">assemble_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This class inherits from RandomProcess and creates a Matern 5/2 covariance matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute scaled distances.</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span>

        <span class="c1"># Set up Matern 5/2 covariance matrix.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dist</span> <span class="o">+</span> <span class="n">dist</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-the-Gravity-model-and-generate-data">
<h3>Define the Gravity model and generate data<a class="headerlink" href="#Define-the-Gravity-model-and-generate-data" title="Permalink to this headline">¶</a></h3>
<p>This is a bit lengthy due to the model used in this case, it contains class definitions and also instantiation of class objects and data generation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set the model parameters.</span>
<span class="n">depth</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">n_quad</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">n_data</span> <span class="o">=</span> <span class="mi">64</span>

<span class="c1"># noise level</span>
<span class="n">noise_level</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="c1"># Set random process parameters.</span>
<span class="n">lamb</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">mkl</span> <span class="o">=</span> <span class="mi">14</span>

<span class="c1"># Set the quadrature degree for each model level (coarsest first)</span>
<span class="n">n_quadrature</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Gravity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gravity is a class that implements a simple gravity surveying problem,</span>
<span class="sd">    as described in Hansen, P. C. (2010). Discrete Inverse Problems: Insight and Algorithms.</span>
<span class="sd">    Society for Industrial and Applied Mathematics.</span>
<span class="sd">    It uses midpoint quadrature to evaluate a Fredholm integral of the first kind.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_function</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_quad</span><span class="p">,</span> <span class="n">n_data</span><span class="p">):</span>

        <span class="c1"># Set the function describing the distribution of subsurface density.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_function</span> <span class="o">=</span> <span class="n">f_function</span>

        <span class="c1"># Set the depth of the density (distance to the surface measurements).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>

        <span class="c1"># Set the quadrature degree along one dimension.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">=</span> <span class="n">n_quad</span>

        <span class="c1"># Set the number of data points along one dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">=</span> <span class="n">n_data</span>

        <span class="c1"># Set the quadrature points.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">TX</span><span class="p">,</span> <span class="n">TY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span>

        <span class="c1"># Set the measurement points.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">)</span>
        <span class="n">SX</span><span class="p">,</span> <span class="n">SY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">)</span>

        <span class="c1"># Create coordinate vectors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">TX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">TY</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">SX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">SY</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># Set the quadrature weights.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Compute a distance matrix</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_coords</span><span class="p">)</span>

        <span class="c1"># Create the Fremholm kernel.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">/</span> <span class="n">dist</span> <span class="o">**</span> <span class="mi">3</span>

        <span class="c1"># Evaluate the density function on the quadrature points.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_function</span><span class="p">(</span><span class="n">TX</span><span class="p">,</span> <span class="n">TY</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Compute the surface density (noiseless measurements)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Plot the density and the signal.</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span><span class="p">),</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Signal&quot;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">),</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Plot the kernel.</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># This is a function describing the subsurface density.</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">TX</span><span class="p">,</span> <span class="n">TY</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">TX</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">TY</span><span class="p">)</span> <span class="o">+</span> <span class="n">TY</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Initialise a model</span>
<span class="n">model_true</span> <span class="o">=</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_quad</span><span class="p">,</span> <span class="n">n_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_true</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_13_0.png" src="../_images/notebooks_MLDA_gravity_surveying_13_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add noise to the data.</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">,</span> <span class="n">n_data</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">model_true</span><span class="o">.</span><span class="n">g</span> <span class="o">+</span> <span class="n">noise</span>

<span class="c1"># Plot the density and the signal.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noiseless Signal&quot;</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">model_true</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_data</span><span class="p">,</span> <span class="n">n_data</span><span class="p">),</span>
    <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noisy Signal&quot;</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_data</span><span class="p">,</span> <span class="n">n_data</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_14_0.png" src="../_images/notebooks_MLDA_gravity_surveying_14_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Gravity_Forward</span><span class="p">(</span><span class="n">Gravity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gravity forward is a class that implements the gravity problem,</span>
<span class="sd">    but computation of signal and density is delayed to the &quot;solve&quot;</span>
<span class="sd">    method, since it relied on a Gaussian Random Field to model</span>
<span class="sd">    the (unknown) density.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">n_quad</span><span class="p">,</span> <span class="n">n_data</span><span class="p">):</span>

        <span class="c1"># Set the depth of the density (distance to the surface measurements).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>

        <span class="c1"># Set the quadrature degree along one axis.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">=</span> <span class="n">n_quad</span>

        <span class="c1"># Set the number of data points along one axis.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">=</span> <span class="n">n_data</span>

        <span class="c1"># Set the quadrature points.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">TX</span><span class="p">,</span> <span class="n">TY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span>

        <span class="c1"># Set the measurement points.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">)</span>
        <span class="n">SX</span><span class="p">,</span> <span class="n">SY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">)</span>

        <span class="c1"># Create coordinate vectors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">TX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">TY</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">SX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">SY</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># Set the quadrature weights.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_quad</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Compute a distance matrix</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_coords</span><span class="p">)</span>

        <span class="c1"># Create the Fremholm kernel.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">/</span> <span class="n">dist</span> <span class="o">**</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">set_random_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_process</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">mkl</span><span class="p">):</span>

        <span class="c1"># Set the number of KL modes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mkl</span> <span class="o">=</span> <span class="n">mkl</span>

        <span class="c1"># Initialise a random process on the quadrature points.</span>
        <span class="c1"># and compute the eigenpairs of the covariance matrix,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_process</span> <span class="o">=</span> <span class="n">random_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkl</span><span class="p">,</span> <span class="n">lamb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">compute_eigenpairs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>

        <span class="c1"># Internalise the Random Field parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>

        <span class="c1"># Create a realisation of the random process, given the parameters.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">stdev</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Set the density.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">stdev</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">random_field</span>

        <span class="c1"># Compute the signal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Get the data vector.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># We project the eigenmodes of the fine model to the quadrature points</span>
<span class="c1"># of the coarse model using linear interpolation.</span>
<span class="k">def</span> <span class="nf">project_eigenmodes</span><span class="p">(</span><span class="n">model_coarse</span><span class="p">,</span> <span class="n">model_fine</span><span class="p">):</span>
    <span class="n">model_coarse</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">model_fine</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">eigenvalues</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model_coarse</span><span class="o">.</span><span class="n">mkl</span><span class="p">):</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span>
            <span class="n">model_fine</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span>
            <span class="n">model_fine</span><span class="o">.</span><span class="n">ty</span><span class="p">,</span>
            <span class="n">model_fine</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">model_fine</span><span class="o">.</span><span class="n">n_quad</span><span class="p">,</span> <span class="n">model_fine</span><span class="o">.</span><span class="n">n_quad</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">model_coarse</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span>
            <span class="n">model_coarse</span><span class="o">.</span><span class="n">tx</span><span class="p">,</span> <span class="n">model_coarse</span><span class="o">.</span><span class="n">ty</span>
        <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Initialise the models, according the quadrature degree.</span>
<span class="n">my_models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n_quad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_quadrature</span><span class="p">):</span>
    <span class="n">my_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Gravity_Forward</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">n_quad</span><span class="p">,</span> <span class="n">n_data</span><span class="p">))</span>
    <span class="n">my_models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_random_process</span><span class="p">(</span><span class="n">Matern52</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">mkl</span><span class="p">)</span>

<span class="c1"># Project the eigenmodes of the fine model to the coarse model.</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">my_models</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">project_eigenmodes</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Solve-and-plot-models-to-demonstrate-coarse/fine-difference">
<h3>Solve and plot models to demonstrate coarse/fine difference<a class="headerlink" href="#Solve-and-plot-models-to-demonstrate-coarse/fine-difference" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Plot the same random realisation for each level, and the corresponding signal,</span>
<span class="c1"># to validate that the levels are equivalents.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_models</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">mkl</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Level 0:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_19_1.png" src="../_images/notebooks_MLDA_gravity_surveying_19_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Level 1:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_19_3.png" src="../_images/notebooks_MLDA_gravity_surveying_19_3.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Largest </span><span class="si">{</span><span class="n">mkl</span><span class="si">}</span><span class="s2"> KL eigenvalues of GP prior&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">random_process</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_20_0.png" src="../_images/notebooks_MLDA_gravity_surveying_20_0.png" />
</div>
</div>
</div>
<div class="section" id="Compare-computation-cost-of-coarse-and-fine-model-solve">
<h3>Compare computation cost of coarse and fine model solve<a class="headerlink" href="#Compare-computation-cost-of-coarse-and-fine-model-solve" title="Permalink to this headline">¶</a></h3>
<p>The bigger the difference in time, the more MLDA has potential to increase efficiency</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>it
<span class="n">my_models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">mkl</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
732 µs ± 63.6 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>it
<span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">mkl</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8.54 ms ± 236 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div></div>
</div>
</div>
<div class="section" id="Set-MCMC-parameters-for-inference">
<h3>Set MCMC parameters for inference<a class="headerlink" href="#Set-MCMC-parameters-for-inference" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Number of draws from the distribution</span>
<span class="n">ndraws</span> <span class="o">=</span> <span class="mi">15000</span>

<span class="c1"># Number of burn-in samples</span>
<span class="n">nburn</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># MLDA and Metropolis tuning parameters</span>
<span class="n">tune</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">tune_interval</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Set high to prevent tuning.</span>
<span class="n">discard_tuning</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Number of independent chains.</span>
<span class="n">nchains</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Subsampling rate for MLDA</span>
<span class="n">nsub</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Set prior parameters for multivariate Gaussian prior distribution.</span>
<span class="n">mu_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mkl</span><span class="p">)</span>
<span class="n">cov_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">mkl</span><span class="p">)</span>

<span class="c1"># Set the sigma for inference.</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Sampling seed</span>
<span class="n">sampling_seed</span> <span class="o">=</span> <span class="n">RANDOM_SEED</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-a-Theano-Op-for-the-likelihood">
<h3>Define a Theano Op for the likelihood<a class="headerlink" href="#Define-a-Theano-Op-for-the-likelihood" title="Permalink to this headline">¶</a></h3>
<p>This creates the theano op needed to pass the above model to the PyMC3 sampler</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">my_loglik</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This returns the log-likelihood of my_model given theta,</span>
<span class="sd">    datapoints, the observed data and sigma. It uses the</span>
<span class="sd">    model_wrapper function to do a model solve.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_model</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">output</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LogLike</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">Op</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Theano Op that wraps the log-likelihood computation, necessary to</span>
<span class="sd">    pass &quot;black-box&quot; code into pymc3.</span>
<span class="sd">    Based on the work in:</span>
<span class="sd">    https://docs.pymc.io/notebooks/blackbox_external_likelihood.html</span>
<span class="sd">    https://docs.pymc.io/Advanced_usage_of_Theano_in_PyMC3.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Specify what type of object will be passed and returned to the Op when it is</span>
    <span class="c1"># called. In our case we will be passing it a vector of values (the parameters</span>
    <span class="c1"># that define our model and a model object) and returning a single &quot;scalar&quot;</span>
    <span class="c1"># value (the log-likelihood)</span>
    <span class="n">itypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">dvector</span><span class="p">]</span>  <span class="c1"># expects a vector of parameter values when called</span>
    <span class="n">otypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">dscalar</span><span class="p">]</span>  <span class="c1"># outputs a single scalar value (the log likelihood)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_model</span><span class="p">,</span> <span class="n">loglike</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the Op with various things that our log-likelihood function</span>
<span class="sd">        requires. Below are the things that are needed in this particular</span>
<span class="sd">        example.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        my_model:</span>
<span class="sd">            A Model object (defined in model.py) that contains the parameters</span>
<span class="sd">            and functions of out model.</span>
<span class="sd">        loglike:</span>
<span class="sd">            The log-likelihood function we&#39;ve defined, in this example it is</span>
<span class="sd">            my_loglik.</span>
<span class="sd">        data:</span>
<span class="sd">            The &quot;observed&quot; data that our log-likelihood function takes in. These</span>
<span class="sd">            are the true data generated by the finest model in this example.</span>
<span class="sd">        x:</span>
<span class="sd">            The dependent variable (aka &#39;x&#39;) that our model requires. This is</span>
<span class="sd">            the datapoints in this example.</span>
<span class="sd">        sigma:</span>
<span class="sd">            The noise standard deviation that our function requires.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add inputs as class attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_model</span> <span class="o">=</span> <span class="n">my_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">loglike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="c1"># the method that is used when calling the Op</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">inputs</span>  <span class="c1"># this will contain my variables</span>

        <span class="c1"># call the log-likelihood function</span>
        <span class="n">logl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_model</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>

        <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">logl</span><span class="p">)</span>  <span class="c1"># output the log-likelihood</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create Theano Ops to wrap likelihoods of all model levels and store them in list</span>
<span class="n">logl</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_models</span><span class="p">):</span>
    <span class="n">logl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LogLike</span><span class="p">(</span><span class="n">m_i</span><span class="p">,</span> <span class="n">my_loglik</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Create-coarse-model-in-PyMC3">
<h3>Create coarse model in PyMC3<a class="headerlink" href="#Create-coarse-model-in-PyMC3" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up models in pymc3 for each level - excluding finest model level</span>
<span class="n">coarse_models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">my_models</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>

        <span class="c1"># Multivariate normal prior.</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MvNormal</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu_prior</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov_prior</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">mkl</span><span class="p">)</span>

        <span class="c1"># Use the Potential class to evaluate likelihood</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span> <span class="n">logl</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="n">theta</span><span class="p">))</span>

    <span class="n">coarse_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Create-fine-model-and-perform-inference">
<h3>Create fine model and perform inference<a class="headerlink" href="#Create-fine-model-and-perform-inference" title="Permalink to this headline">¶</a></h3>
<p>Note that we sample using all three methods and that we use the MAP as the starting point for sampling</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up finest model and perform inference with PyMC3, using the MLDA algorithm</span>
<span class="c1"># and passing the coarse_models list created above.</span>
<span class="n">method_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">runtimes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>

    <span class="c1"># Multivariate normal prior.</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MvNormal</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu_prior</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov_prior</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">mkl</span><span class="p">)</span>

    <span class="c1"># Use the Potential class to evaluate likelihood</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span> <span class="n">logl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">theta</span><span class="p">))</span>

    <span class="c1"># Find the MAP estimate which is used as the starting point for sampling</span>
    <span class="n">MAP</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>

    <span class="c1"># Initialise a Metropolis, DEMetropolisZ and MLDA step method objects (passing the subsampling rate and</span>
    <span class="c1"># coarse models list for the latter)</span>
    <span class="n">step_metropolis</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Metropolis</span><span class="p">(</span><span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span> <span class="n">tune_interval</span><span class="o">=</span><span class="n">tune_interval</span><span class="p">)</span>
    <span class="n">step_demetropolisz</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">DEMetropolisZ</span><span class="p">(</span><span class="n">tune_interval</span><span class="o">=</span><span class="n">tune_interval</span><span class="p">)</span>
    <span class="n">step_mlda</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MLDA</span><span class="p">(</span>
        <span class="n">coarse_models</span><span class="o">=</span><span class="n">coarse_models</span><span class="p">,</span> <span class="n">subsampling_rates</span><span class="o">=</span><span class="n">nsub</span><span class="p">,</span> <span class="n">base_tune_interval</span><span class="o">=</span><span class="n">tune_interval</span>
    <span class="p">)</span>

    <span class="c1"># Inference!</span>
    <span class="c1"># Metropolis</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Metropolis&quot;</span><span class="p">)</span>
    <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">draws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step_metropolis</span><span class="p">,</span>
            <span class="n">chains</span><span class="o">=</span><span class="n">nchains</span><span class="p">,</span>
            <span class="n">tune</span><span class="o">=</span><span class="n">nburn</span><span class="p">,</span>
            <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="n">discard_tuning</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">sampling_seed</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">MAP</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">runtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span>

    <span class="c1"># DEMetropolisZ</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DEMetropolisZ&quot;</span><span class="p">)</span>
    <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">draws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step_demetropolisz</span><span class="p">,</span>
            <span class="n">chains</span><span class="o">=</span><span class="n">nchains</span><span class="p">,</span>
            <span class="n">tune</span><span class="o">=</span><span class="n">nburn</span><span class="p">,</span>
            <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="n">discard_tuning</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">sampling_seed</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">MAP</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">runtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span>

    <span class="c1"># MLDA</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MLDA&quot;</span><span class="p">)</span>
    <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">draws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step_mlda</span><span class="p">,</span>
            <span class="n">chains</span><span class="o">=</span><span class="n">nchains</span><span class="p">,</span>
            <span class="n">tune</span><span class="o">=</span><span class="n">nburn</span><span class="p">,</span>
            <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="n">discard_tuning</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">sampling_seed</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">MAP</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">runtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Warning: gradient not available.(E.g. vars contains discrete variables). MAP estimates may not be accurate for the default parameters. Defaulting to non-gradient minimization &#39;Powell&#39;.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='510' class='' max='510' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [510/510 00:05<00:00 logp = -35.343]
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/mikkel/venv/pymc3_mlda_develop/lib/python3.6/site-packages/pymc3/step_methods/mlda.py:385: UserWarning: The MLDA implementation in PyMC3 is still immature. You should be particularly critical of its results.
  &#34;The MLDA implementation in PyMC3 is still immature. You should be particularly critical of its results.&#34;
Multiprocess sampling (3 chains in 4 jobs)
Metropolis: [theta]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='75000' class='' max='75000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [75000/75000 11:40<00:00 Sampling 3 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 3 chains for 10_000 tune and 15_000 draw iterations (30_000 + 45_000 draws total) took 700 seconds.
The estimated number of effective samples is smaller than 200 for some parameters.
Multiprocess sampling (3 chains in 4 jobs)
DEMetropolisZ: [theta]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='75000' class='' max='75000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [75000/75000 10:48<00:00 Sampling 3 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 3 chains for 10_000 tune and 15_000 draw iterations (30_000 + 45_000 draws total) took 648 seconds.
The number of effective samples is smaller than 10% for some parameters.
Multiprocess sampling (3 chains in 4 jobs)
MLDA: [theta]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='75000' class='' max='75000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [75000/75000 25:43<00:00 Sampling 3 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 3 chains for 10_000 tune and 15_000 draw iterations (30_000 + 45_000 draws total) took 1544 seconds.
The number of effective samples is smaller than 10% for some parameters.
</pre></div></div>
</div>
</div>
<div class="section" id="Get-post-sampling-stats-and-diagnostics">
<h3>Get post-sampling stats and diagnostics<a class="headerlink" href="#Get-post-sampling-stats-and-diagnostics" title="Permalink to this headline">¶</a></h3>
<div class="section" id="Print-MAP-estimate-and-pymc3-sampling-summary">
<h4>Print MAP estimate and pymc3 sampling summary<a class="headerlink" href="#Print-MAP-estimate-and-pymc3-sampling-summary" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detailed summaries and plots:</span><span class="se">\n</span><span class="s2">MAP estimate: </span><span class="si">{</span><span class="n">MAP</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Not used as starting point.&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">method_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> Sampler:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Detailed summaries and plots:
MAP estimate: [ 2.27538512e+00  2.02952996e-01  2.10514255e-01  3.35678343e-04
  1.47801781e+00 -8.33319176e-01  3.51351707e-02 -9.71261318e-02
 -1.11577626e-01  1.15377339e-01  4.56230031e-01 -1.30953228e-04
  1.37797862e-03  3.94296444e-02]. Not used as starting point.

Metropolis Sampler:

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>theta[0]</th>
      <td>2.276</td>
      <td>0.015</td>
      <td>2.247</td>
      <td>2.302</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>2915.0</td>
      <td>2915.0</td>
      <td>2914.0</td>
      <td>5155.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[1]</th>
      <td>0.203</td>
      <td>0.020</td>
      <td>0.166</td>
      <td>0.242</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1777.0</td>
      <td>1777.0</td>
      <td>1776.0</td>
      <td>3218.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[2]</th>
      <td>0.210</td>
      <td>0.020</td>
      <td>0.174</td>
      <td>0.249</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1968.0</td>
      <td>1962.0</td>
      <td>1967.0</td>
      <td>3861.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[3]</th>
      <td>-0.000</td>
      <td>0.026</td>
      <td>-0.050</td>
      <td>0.050</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>926.0</td>
      <td>926.0</td>
      <td>926.0</td>
      <td>2043.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[4]</th>
      <td>1.478</td>
      <td>0.030</td>
      <td>1.419</td>
      <td>1.532</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>998.0</td>
      <td>998.0</td>
      <td>999.0</td>
      <td>1876.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[5]</th>
      <td>-0.833</td>
      <td>0.029</td>
      <td>-0.887</td>
      <td>-0.780</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1108.0</td>
      <td>1108.0</td>
      <td>1109.0</td>
      <td>2198.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[6]</th>
      <td>0.033</td>
      <td>0.037</td>
      <td>-0.033</td>
      <td>0.102</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>650.0</td>
      <td>650.0</td>
      <td>652.0</td>
      <td>1284.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[7]</th>
      <td>-0.098</td>
      <td>0.036</td>
      <td>-0.164</td>
      <td>-0.028</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>554.0</td>
      <td>554.0</td>
      <td>554.0</td>
      <td>1269.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[8]</th>
      <td>-0.110</td>
      <td>0.046</td>
      <td>-0.198</td>
      <td>-0.023</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>384.0</td>
      <td>384.0</td>
      <td>385.0</td>
      <td>762.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[9]</th>
      <td>0.120</td>
      <td>0.046</td>
      <td>0.034</td>
      <td>0.209</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>427.0</td>
      <td>426.0</td>
      <td>427.0</td>
      <td>740.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>theta[10]</th>
      <td>0.454</td>
      <td>0.049</td>
      <td>0.364</td>
      <td>0.547</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>365.0</td>
      <td>365.0</td>
      <td>366.0</td>
      <td>711.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[11]</th>
      <td>0.000</td>
      <td>0.054</td>
      <td>-0.098</td>
      <td>0.101</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>328.0</td>
      <td>328.0</td>
      <td>328.0</td>
      <td>752.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[12]</th>
      <td>0.003</td>
      <td>0.057</td>
      <td>-0.102</td>
      <td>0.110</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>296.0</td>
      <td>296.0</td>
      <td>295.0</td>
      <td>644.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>theta[13]</th>
      <td>0.034</td>
      <td>0.071</td>
      <td>-0.100</td>
      <td>0.173</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>135.0</td>
      <td>135.0</td>
      <td>136.0</td>
      <td>313.0</td>
      <td>1.03</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

DEMetropolisZ Sampler:

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>theta[0]</th>
      <td>2.275</td>
      <td>0.015</td>
      <td>2.247</td>
      <td>2.302</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>935.0</td>
      <td>935.0</td>
      <td>936.0</td>
      <td>1858.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[1]</th>
      <td>0.202</td>
      <td>0.019</td>
      <td>0.165</td>
      <td>0.238</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>1027.0</td>
      <td>1023.0</td>
      <td>1028.0</td>
      <td>1832.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[2]</th>
      <td>0.211</td>
      <td>0.020</td>
      <td>0.173</td>
      <td>0.247</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>941.0</td>
      <td>941.0</td>
      <td>941.0</td>
      <td>1971.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>theta[3]</th>
      <td>0.001</td>
      <td>0.026</td>
      <td>-0.047</td>
      <td>0.050</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1146.0</td>
      <td>1146.0</td>
      <td>1147.0</td>
      <td>2152.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[4]</th>
      <td>1.480</td>
      <td>0.029</td>
      <td>1.426</td>
      <td>1.533</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1109.0</td>
      <td>1109.0</td>
      <td>1111.0</td>
      <td>2021.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[5]</th>
      <td>-0.833</td>
      <td>0.030</td>
      <td>-0.889</td>
      <td>-0.776</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>984.0</td>
      <td>981.0</td>
      <td>984.0</td>
      <td>2105.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[6]</th>
      <td>0.033</td>
      <td>0.037</td>
      <td>-0.036</td>
      <td>0.103</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>950.0</td>
      <td>950.0</td>
      <td>947.0</td>
      <td>1988.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[7]</th>
      <td>-0.096</td>
      <td>0.036</td>
      <td>-0.165</td>
      <td>-0.030</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1079.0</td>
      <td>1079.0</td>
      <td>1081.0</td>
      <td>2189.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[8]</th>
      <td>-0.113</td>
      <td>0.046</td>
      <td>-0.196</td>
      <td>-0.027</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>851.0</td>
      <td>851.0</td>
      <td>854.0</td>
      <td>1646.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[9]</th>
      <td>0.117</td>
      <td>0.045</td>
      <td>0.031</td>
      <td>0.199</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1018.0</td>
      <td>989.0</td>
      <td>1023.0</td>
      <td>1815.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[10]</th>
      <td>0.459</td>
      <td>0.047</td>
      <td>0.368</td>
      <td>0.547</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1059.0</td>
      <td>1059.0</td>
      <td>1059.0</td>
      <td>2100.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[11]</th>
      <td>0.001</td>
      <td>0.054</td>
      <td>-0.102</td>
      <td>0.100</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>1055.0</td>
      <td>1055.0</td>
      <td>1055.0</td>
      <td>1871.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[12]</th>
      <td>-0.002</td>
      <td>0.054</td>
      <td>-0.101</td>
      <td>0.102</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>1016.0</td>
      <td>1016.0</td>
      <td>1016.0</td>
      <td>1952.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>theta[13]</th>
      <td>0.038</td>
      <td>0.070</td>
      <td>-0.104</td>
      <td>0.161</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>974.0</td>
      <td>974.0</td>
      <td>974.0</td>
      <td>1804.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

MLDA Sampler:

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>theta[0]</th>
      <td>2.275</td>
      <td>0.015</td>
      <td>2.248</td>
      <td>2.303</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>3722.0</td>
      <td>3721.0</td>
      <td>3723.0</td>
      <td>6680.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[1]</th>
      <td>0.203</td>
      <td>0.020</td>
      <td>0.166</td>
      <td>0.242</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>4041.0</td>
      <td>4041.0</td>
      <td>4041.0</td>
      <td>7792.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[2]</th>
      <td>0.210</td>
      <td>0.020</td>
      <td>0.173</td>
      <td>0.249</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>4236.0</td>
      <td>4224.0</td>
      <td>4240.0</td>
      <td>7677.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[3]</th>
      <td>0.000</td>
      <td>0.026</td>
      <td>-0.049</td>
      <td>0.048</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>4143.0</td>
      <td>4143.0</td>
      <td>4143.0</td>
      <td>7597.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[4]</th>
      <td>1.478</td>
      <td>0.030</td>
      <td>1.420</td>
      <td>1.533</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3386.0</td>
      <td>3384.0</td>
      <td>3386.0</td>
      <td>6788.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[5]</th>
      <td>-0.833</td>
      <td>0.030</td>
      <td>-0.890</td>
      <td>-0.777</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>3856.0</td>
      <td>3846.0</td>
      <td>3858.0</td>
      <td>6848.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[6]</th>
      <td>0.035</td>
      <td>0.036</td>
      <td>-0.032</td>
      <td>0.104</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3612.0</td>
      <td>3612.0</td>
      <td>3615.0</td>
      <td>6917.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[7]</th>
      <td>-0.097</td>
      <td>0.037</td>
      <td>-0.167</td>
      <td>-0.028</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3982.0</td>
      <td>3982.0</td>
      <td>3989.0</td>
      <td>6996.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[8]</th>
      <td>-0.112</td>
      <td>0.046</td>
      <td>-0.199</td>
      <td>-0.029</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3702.0</td>
      <td>3702.0</td>
      <td>3702.0</td>
      <td>7305.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[9]</th>
      <td>0.115</td>
      <td>0.046</td>
      <td>0.029</td>
      <td>0.203</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4123.0</td>
      <td>4123.0</td>
      <td>4127.0</td>
      <td>7350.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[10]</th>
      <td>0.457</td>
      <td>0.049</td>
      <td>0.363</td>
      <td>0.548</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4032.0</td>
      <td>4032.0</td>
      <td>4036.0</td>
      <td>7503.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[11]</th>
      <td>0.001</td>
      <td>0.053</td>
      <td>-0.097</td>
      <td>0.104</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4283.0</td>
      <td>4283.0</td>
      <td>4284.0</td>
      <td>7967.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[12]</th>
      <td>0.001</td>
      <td>0.055</td>
      <td>-0.099</td>
      <td>0.105</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4034.0</td>
      <td>4034.0</td>
      <td>4033.0</td>
      <td>7543.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>theta[13]</th>
      <td>0.040</td>
      <td>0.070</td>
      <td>-0.091</td>
      <td>0.173</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4118.0</td>
      <td>4118.0</td>
      <td>4116.0</td>
      <td>7760.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Show-ESS-and-ESS/sec-for-all-samplers">
<h4>Show ESS and ESS/sec for all samplers<a class="headerlink" href="#Show-ESS-and-ESS/sec-for-all-samplers" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ess</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ess_n</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">performances</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Get some more statistics.</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">get_sampler_stats</span><span class="p">(</span><span class="s2">&quot;accepted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()))</span>
        <span class="n">ess_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span> <span class="o">/</span> <span class="n">trace</span><span class="o">.</span><span class="n">nchains</span><span class="p">)</span>
        <span class="n">performances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">runtimes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">method_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> Sampler: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span><span class="si">}</span><span class="s2"> drawn samples in each of &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trace</span><span class="o">.</span><span class="n">nchains</span><span class="si">}</span><span class="s2"> chains.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Runtime: </span><span class="si">{</span><span class="n">runtimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Acceptance rate: </span><span class="si">{</span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ESS list: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ess</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalised ESS list: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ess_n</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ESS/sec: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">performances</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Plot the effective sample size (ESS) and relative ESS (ES/sec) of each of the sampling strategies.</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;firebrick&quot;</span><span class="p">,</span> <span class="s2">&quot;darkgoldenrod&quot;</span><span class="p">,</span> <span class="s2">&quot;darkcyan&quot;</span><span class="p">,</span> <span class="s2">&quot;olivedrab&quot;</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ESS&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ess</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mkl</span><span class="p">)],</span>
            <span class="n">e</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">method_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mkl</span><span class="p">)])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;theta_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mkl</span><span class="p">)])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ES/sec&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">performances</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mkl</span><span class="p">)],</span>
            <span class="n">p</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">method_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mkl</span><span class="p">)])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;theta_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mkl</span><span class="p">)])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Metropolis Sampler: 15000 drawn samples in each of 3 chains.
Runtime: 700.6343622207642 seconds
Acceptance rate: 0.3526666666666667
ESS list: [2914.341 1775.745 1967.064  925.843  999.187 1109.362  651.887  554.216
  384.809  426.968  366.078  327.948  295.304  136.047]
Normalised ESS list: [0.065 0.039 0.044 0.021 0.022 0.025 0.014 0.012 0.009 0.009 0.008 0.007
 0.007 0.003]
ESS/sec: [4.16  2.534 2.808 1.321 1.426 1.583 0.93  0.791 0.549 0.609 0.522 0.468
 0.421 0.194]

DEMetropolisZ Sampler: 15000 drawn samples in each of 3 chains.
Runtime: 649.0431413650513 seconds
Acceptance rate: 0.2856222222222222
ESS list: [ 936.218 1027.716  940.562 1147.093 1111.207  984.099  946.92  1081.054
  853.847 1023.429 1059.481 1054.556 1016.246  973.636]
Normalised ESS list: [0.021 0.023 0.021 0.025 0.025 0.022 0.021 0.024 0.019 0.023 0.024 0.023
 0.023 0.022]
ESS/sec: [1.442 1.583 1.449 1.767 1.712 1.516 1.459 1.666 1.316 1.577 1.632 1.625
 1.566 1.5  ]

MLDA Sampler: 15000 drawn samples in each of 3 chains.
Runtime: 1544.3724060058594 seconds
Acceptance rate: 0.7362666666666666
ESS list: [3723.089 4040.887 4239.689 4142.525 3386.089 3857.995 3614.949 3988.714
 3702.003 4127.191 4036.327 4283.589 4032.846 4115.822]
Normalised ESS list: [0.083 0.09  0.094 0.092 0.075 0.086 0.08  0.089 0.082 0.092 0.09  0.095
 0.09  0.091]
ESS/sec: [2.411 2.617 2.745 2.682 2.193 2.498 2.341 2.583 2.397 2.672 2.614 2.774
 2.611 2.665]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_37_1.png" src="../_images/notebooks_MLDA_gravity_surveying_37_1.png" />
</div>
</div>
</div>
<div class="section" id="Plot-distributions-and-trace.">
<h4>Plot distributions and trace.<a class="headerlink" href="#Plot-distributions-and-trace." title="Permalink to this headline">¶</a></h4>
<p>Vertical grey lines represent the MAP estimate of each parameter.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">MAP</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">traceplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">)</span>

        <span class="c1"># Ugly hack to get some titles in.</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">ndraws</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Sampler&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_39_0.png" src="../_images/notebooks_MLDA_gravity_surveying_39_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_39_1.png" src="../_images/notebooks_MLDA_gravity_surveying_39_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_39_2.png" src="../_images/notebooks_MLDA_gravity_surveying_39_2.png" />
</div>
</div>
</div>
<div class="section" id="Plot-true-and-recovered-densities">
<h4>Plot true and recovered densities<a class="headerlink" href="#Plot-true-and-recovered-densities" title="Permalink to this headline">¶</a></h4>
<p>This is useful for verification, i.e. to compare the true model density and signal to the estimated ones from the samplers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;True Model&quot;</span><span class="p">)</span>
<span class="n">model_true</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAP estimate:&quot;</span><span class="p">)</span>
    <span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">MAP</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">])</span>
    <span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovered by: </span><span class="si">{</span><span class="n">method_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">my_models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True Model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_41_1.png" src="../_images/notebooks_MLDA_gravity_surveying_41_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MAP estimate:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_41_3.png" src="../_images/notebooks_MLDA_gravity_surveying_41_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Recovered by: Metropolis
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_41_5.png" src="../_images/notebooks_MLDA_gravity_surveying_41_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Recovered by: DEMetropolisZ
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_41_7.png" src="../_images/notebooks_MLDA_gravity_surveying_41_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Recovered by: MLDA
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_41_9.png" src="../_images/notebooks_MLDA_gravity_surveying_41_9.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Show trace of lowest energy mode for Metropolis sampler</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;theta&quot;</span><span class="p">][:</span><span class="mi">5000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_42_0.png" src="../_images/notebooks_MLDA_gravity_surveying_42_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Show trace of lowest energy mode for MLDA sampler</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;theta&quot;</span><span class="p">][:</span><span class="mi">5000</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MLDA_gravity_surveying_43_0.png" src="../_images/notebooks_MLDA_gravity_surveying_43_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Make sure samplers have converged</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">rhat</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.03</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">rhat</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.03</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">rhat</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.03</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/mikkel/venv/pymc3_mlda_develop/lib/python3.6/site-packages/arviz/data/io_pymc3.py:91: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  FutureWarning,
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">watermark</span> -n -u -v -iv -w
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The watermark extension is already loaded. To reload it, use:
  %reload_ext watermark
numpy  1.19.2
arviz  0.10.0
theano 1.0.5
pymc3  3.9.3
pandas 1.1.3
last updated: Thu Oct 15 2020

CPython 3.6.9
IPython 7.16.1
watermark 2.0.2
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


    </div>
</div>
<div class="ui vertical footer segment">
    <div class="ui center aligned container">
        <a href="https://github.com/pymc-devs/pymc3"><i class="github icon large"></i></a>
        <a href="https://twitter.com/pymc_devs"><i class="twitter icon large"></i></a>
        <a href="https://discourse.pymc.io/"><i class="discourse icon large"></i></a>
    </div>
    <div class="ui center aligned container">This page uses <a href="https://analytics.google.com/">
    Google Analytics</a> to collect statistics. You can disable it by blocking
    the JavaScript coming from www.google-analytics.com.
    <script>
      (function() {
        var ga = document.createElement('script');
        ga.src = ('https:' == document.location.protocol ?
                  'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        ga.setAttribute('async', 'true');
        document.documentElement.firstChild.appendChild(ga);
      })();
    </script>
    </div>
    <div class="ui center aligned container">
        <p>
            &copy; Copyright 2018, The PyMC Development Team.
        </p>
        <p>
            Created using <a href="https://sphinx-doc.org/">Sphinx</a> 3.4.0.<br />
        </p>
    </div>
</div>
  </body>
</html>